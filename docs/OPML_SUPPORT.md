# OPML Import/Export Support

## Overview

Podcast TUI now supports importing and exporting podcast subscriptions using the OPML (Outline Processor Markup Language) format. This allows you to easily migrate your subscriptions between podcast apps or backup your subscription list.

## Features

- **Import from OPML files or URLs**
  - Supports both local file paths and HTTP(S) URLs
  - Non-destructive import (skips duplicates automatically)
  - Sequential processing with progress updates
  - Detailed error logging

- **Export to OPML format**
  - Standard OPML 2.0 compliant format
  - Configurable export location
  - Timestamped filenames by default
  - Compatible with other podcast applications

## Quick Start

### Importing Podcasts

**Using Keyboard Shortcut:**
1. Press `Shift+A` to open the import prompt
2. Enter the path to your OPML file or a URL
3. Watch the progress as feeds are imported

**Using Command:**
```
:import-opml ~/my-podcasts.opml
```

Or just enter the command to get a prompt:
```
:import-opml
```

### Exporting Podcasts

**Using Keyboard Shortcut:**
1. Press `Shift+E` to open the export prompt
2. Press Enter to use the default location, or enter a custom path
3. Your subscriptions will be exported with a timestamped filename

**Using Command:**
```
:export-opml ~/backup/podcasts.opml
```

Or use the default location:
```
:export-opml
```

## Configuration

You can configure the default export directory in your config file (`~/.config/podcast-tui/config.json`):

```json
{
  "storage": {
    "opml_export_directory": "~/Documents/podcast-exports"
  }
}
```

## Import Process

When you import an OPML file:

1. **Validation**: The OPML file is validated for proper structure
2. **Feed Extraction**: All RSS feed URLs are extracted
3. **Duplicate Check**: Feeds you're already subscribed to are skipped
4. **Sequential Import**: Feeds are imported one at a time with progress updates
5. **Error Logging**: Any failures are logged to a file for review

### Import Statistics

After import completes, you'll see a summary:
- Total feeds found in OPML
- Successfully imported
- Skipped (duplicates)
- Failed (with reasons)

### Import Logs

Failed imports are logged to: `~/.local/share/podcast-tui/logs/opml-import-YYYY-MM-DD-HHmmss.log`

The log file contains:
- Timestamp of each operation
- Feed titles and URLs
- Success/failure status
- Detailed error messages for failures

## Export Process

When you export your subscriptions:

1. **Load Subscriptions**: All current podcasts are loaded
2. **Generate OPML**: A standard OPML 2.0 document is created
3. **Write File**: The file is written atomically (temp file + rename)
4. **Timestamped Filename**: By default, files are named `podcasts-export-YYYY-MM-DD-HHmmss.opml`

### Export Location

- If you provide a directory path, a timestamped filename is added automatically
- If you provide a full file path, it's used as-is
- If you press Enter without input, the configured default directory is used
- Tilde (`~`) expansion is supported

## OPML Format

### Generated OPML Structure

```xml
<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
  <head>
    <title>Podcast Subscriptions</title>
    <dateCreated>Mon, 06 Oct 2025 14:30:22 GMT</dateCreated>
  </head>
  <body>
    <outline type="rss" 
             text="Example Podcast" 
             title="Example Podcast"
             description="A great podcast about things"
             xmlUrl="https://example.com/feed.xml"/>
    <!-- More podcasts... -->
  </body>
</opml>
```

### Supported OPML Attributes

**Import** (reads):
- `xmlUrl` - Primary feed URL (required)
- `url` - Fallback feed URL
- `text` - Podcast title
- `title` - Alternative title
- `description` - Podcast description

**Export** (writes):
- `type` - Always set to "rss"
- `text` - Podcast title
- `title` - Podcast title (duplicate for compatibility)
- `xmlUrl` - Feed URL
- `description` - Podcast description

## Keybindings

| Key | Action |
|-----|--------|
| `Shift+A` | Import OPML |
| `Shift+E` | Export OPML |

## Commands

| Command | Description |
|---------|-------------|
| `:import-opml [path/url]` | Import from OPML file or URL |
| `:export-opml [path]` | Export to OPML file |

## Examples

### Import from local file
```
:import-opml ~/Downloads/subscriptions.opml
```

### Import from URL
```
:import-opml https://example.com/my-feeds.opml
```

### Export to custom location
```
:export-opml ~/backup/my-podcasts-2025-10-06.opml
```

### Export to default location
```
:export-opml
```
(Press Enter at the prompt to use the configured default directory)

## Compatibility

The OPML format generated by Podcast TUI is compatible with:
- Apple Podcasts
- Overcast
- Pocket Casts
- Castro
- And most other podcast applications that support OPML

## Troubleshooting

### Import Issues

**"Invalid OPML format" error:**
- Ensure the file is valid XML
- Check that it has `<opml>` and `<body>` elements
- Verify it contains `<outline>` elements with feed URLs

**Some feeds fail to import:**
- Check the import log file for detailed errors
- Common issues: network timeouts, invalid feed URLs, malformed RSS feeds
- Successfully imported feeds are still added even if some fail

**No feeds found:**
- Ensure the OPML file contains `<outline>` elements
- Check that outlines have `xmlUrl` or `url` attributes

### Export Issues

**"Permission denied" error:**
- Ensure you have write permissions to the target directory
- Try exporting to a different location

**Directory doesn't exist:**
- Parent directories are created automatically
- Check path syntax and permissions

## Technical Details

### OPML Version
Podcast TUI uses **OPML 2.0** format for maximum compatibility.

### Nested Categories
Current MVP version supports **flat structure only**. Nested categories in imported OPML files are automatically flattened.

### Duplicate Detection
During import, duplicates are detected by comparing feed URLs. Podcasts you're already subscribed to are automatically skipped.

### Atomic Writes
Export uses atomic write operations (temporary file + rename) to prevent data corruption if the operation is interrupted.

### Progress Reporting
Both import and export provide real-time progress updates in the minibuffer, showing:
- Current operation
- Feed being processed
- Success/skip/failure status

## Future Enhancements

Potential improvements for future versions:
- Support for nested OPML categories/folders
- Parallel import with concurrency limits
- Import preview before committing
- Scheduled auto-exports
- Import from popular podcast services
- Import diff showing what will change
- Undo failed imports
